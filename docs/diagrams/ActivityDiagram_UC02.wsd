@startuml TaijiFlow_Activity_Diagram_UC02
' ============================================================================
' TaijiFlow AI - Activity Diagram: UC-02 Perform Training (v2.1 Simplified)
' ============================================================================
' อัปเดต: เพิ่ม Low Light Check, Ghost/Silhouette, รวม activities ให้กระชับ
' อ้างอิง: script.js (lines 124-128, 1442, 1690-1720)
' ============================================================================

skinparam defaultFontName "sarabun"
skinparam activity {
    BackgroundColor White
    BorderColor Black
    ArrowColor Black
}
skinparam note {
    BackgroundColor LightYellow
}

start

:ผู้ใช้เลือก "ท่าฝึก" และ "ระดับความยาก";
note right
    **Quickstart**
    มี default ให้:
    - ท่า: มือขวา-ตามเข็ม
    - ระดับ: L1 (นั่ง)
end note

partition "System Initialization" {
    if (เข้าถึงกล้องได้?) then (ไม่ได้ (E1))
        :แจ้งเตือน "ไม่พบกล้อง";
        stop
    else (ได้)
        :โหลดข้อมูลท่าต้นแบบ (JSON);
        if (พบไฟล์?) then (ไม่พบ (E2))
            :แจ้งเตือน "ไม่พบข้อมูลต้นแบบ";
            stop
        else (พบ)
            :แสดงวิดีโอและเส้นนำทาง;
        endif
    endif
}

:ผู้ใช้กดปุ่ม Start Training;

partition "Calibration (<<include>> UC-01)" {
    :เริ่ม Calibration;
    
    if (แสงเพียงพอ?) then (ไม่พอ (E3))
        :แจ้งเตือนแสงไม่เพียงพอ (Toast + TTS);
        note right
            **Low Light Detection**
            avgVisibility < 0.5
        end note
    else (พอ)
    endif
    
    :รอผู้ใช้ยืน T-Pose และบันทึกสัดส่วน;
    note right: ดูรายละเอียดใน UC-01
}

partition "Countdown & Start" {
    :แสดง Countdown 3-2-1;
    :เริ่มฝึก (Timer + UI Controls);
    note right
        **Optional Display**
        ☐ Ghost Skeleton
        ☐ Silhouette Video
    end note
}

partition "Main Training Loop (Real-time)" {
    repeat
        :รับภาพและตรวจจับท่าทาง;
        
        if (แสงน้อย && เกิน Cooldown?) then (ใช่)
            :เตือนแสงน้อย (Toast + TTS);
            note right: Cooldown = 30s
        else (ไม่)
        endif
        
        :วาด Ghost/Silhouette (ถ้าเปิด);
        
        partition "Heuristics Analysis" {
            :ตรวจสอบตามกฎ 8 ข้อ (ตาม Level);
            note right: ดูใน ActivityDiagram_Heuristics.wsd
        }

        if (พบข้อผิดพลาด?) then (ใช่)
            :แสดง Feedback (ภาพ + เสียง);
        else (ไม่)
            :แสดงผลปกติ (สีเขียว);
        endif

        :บันทึกคะแนน (Logging);

    repeat while (หยุด หรือ หมดเวลา?) is (ไม่)
    -> ใช่ (Stop/Timeout);
}

:Cleanup (Ghost, Fullscreen);
:ส่งข้อมูลไป UC-03 (View Result);

stop
@enduml

