@startuml TaijiFlow_Class_Diagram
' ============================================================================
' TaijiFlow AI - Class Diagram v1.2 (Updated: 2026-01-07)
' ============================================================================
' จัดกลุ่มด้วย Packages เพื่อความชัดเจน
' อ้างอิง: 21 JavaScript Modules
' ============================================================================

skinparam defaultFontName "sarabun"
skinparam packageStyle rectangle

' === Line Style Settings (ลดเส้นซ้อนทับ) ===
left to right direction
skinparam linetype ortho
skinparam nodesep 50
skinparam ranksep 40

skinparam class {
    BackgroundColor White
    BorderColor Black
    ArrowColor Black
}
skinparam package {
    BackgroundColor<<Controller>> #E3F2FD
    BackgroundColor<<Core>> #FFF3E0
    BackgroundColor<<Display>> #E0F7FA
    BackgroundColor<<UI>> #E8F5E9
    BackgroundColor<<Utility>> #F3E5F5
}

' ============================================================================
' CONTROLLERS PACKAGE
' ============================================================================

package "Controllers" <<Controller>> {
    class "script.js" as Script <<Main>> {
        - isTrainingMode: boolean
        - currentExercise: string
        - currentLevel: string
        --
        + startTrainingFlow()
        + endTrainingSession()
        + onResults(results)
        + loadReferenceData()
    }
    
    class KeyboardController {
        - deps: object
        --
        + handleKeydown(event)
        + showShortcutsHelp()
    }
    
    class DisplayController {
        - showGhostOverlay: boolean
        - showPath: boolean
        - showSkeleton: boolean
        - showSilhouette: boolean
        - showTrail: boolean
        - trailHistory: array
        --
        + init()
        + toggleInstructor(show)
        + resetToDefaults()
        + addTrailPoint(x, y)
        + clearTrail()
    }
    
    note as NC
        **จัดการ Application Flow**
        Script = Main Controller
        Keyboard = 14 Shortcuts
        Display = 6 Options
    end note
}

' ============================================================================
' CORE MANAGERS PACKAGE
' ============================================================================

package "Core Managers" <<Core>> {
    class HeuristicsEngine {
        - config: object
        - calibrationData: object
        --
        + analyze(landmarks): Feedback[]
        + setCalibration(data)
        - checkPathShape()
        - checkElbowSinking()
        - checkContinuity()
        - checkContinuity()
        - checkArmRotation()
        .. +4 more rules ..
    }
    
    class CalibrationManager {
        - isActive: boolean
        - calibrationData: object
        - level: string
        --
        + start()
        + stop()
        + cancel()
        + process(landmarks)
        + setLevel(level)
        + drawOverlay(ctx)
    }
    
    class ScoringManager {
        - totalFrames: int
        - correctFrames: int
        --
        + start()
        + recordFrame(feedbacks)
        + getSummary(): object
    }
}

' ============================================================================
' DISPLAY MANAGERS PACKAGE (แยกจาก Core เพราะเป็น View/Render)
' ============================================================================

package "Display Managers" <<Display>> {
    class DrawingManager {
        - ctx: CanvasRenderingContext2D
        - isMirrored: boolean
        --
        + drawSkeleton(landmarks)
        + drawPath(path, color)
        + drawTrail(history)
        + drawFeedbackPanel(feedbacks)
        + drawDebugOverlay(debugInfo)
        + drawGhostSkeleton(landmarks)
        + drawSilhouetteVideo(video, opacity)
        + drawSilhouette(mask, color)
        + drawGestureFeedback(feedback)
        + drawCircularityIndicator(score)
    }
    
    class GhostManager {
        - isPlaying: boolean
        - opacity: number
        - silhouetteVideo: HTMLVideoElement
        --
        + load(data)
        + loadSilhouetteVideo(url)
        + start()
        + stop()
        + update()
        + update()
        + getCurrentFrame()
        + setSpeed(speed)
        + setOpacity(opacity)
    }
    
    class SilhouetteManager {
        - isEnabled: boolean
        - color: string
        --
        + enable()
        + disable()
        + toggle()
        + drawSilhouetteFromMask(ctx, mask)
    }
    
    ' Force horizontal layout
    DrawingManager -[hidden]right- GhostManager
    GhostManager -[hidden]right- SilhouetteManager
}

' ============================================================================
' UI MANAGERS PACKAGE
' ============================================================================

package "UI & Feedback" <<UI>> {
    together {
        class UIManager {
            - currentLang: string
            - currentTheme: string
            --
            + toggleLanguage()
            + toggleTheme()
            + showNotification(msg)
        }
        
        class AudioManager {
            - enabled: boolean
            - cooldown: number
            --
            + speak(message)
            + speakFeedback(feedbacks)
        }
        
        class TutorialManager {
            - isOpen: boolean
            --
            + open(lang)
            + close()
        }
        
        class ScorePopupManager {
            --
            + show(summary, grade)
            + close()
        }
        
        class RulesConfigManager {
            --
            + setRuleEnabled(key, enabled)
            + resetToDefaults()
        }
        
        class GestureManager {
            - isReady: boolean
            --
            + init()
            + detectGestures(video)
        }
        
        class FeedbackManager {
            - formUrl: string
            --
            + createButton()
            + showPopup()
        }
    }
    
    ' Force horizontal layout
    UIManager -[hidden]right- AudioManager
    AudioManager -[hidden]right- TutorialManager
    TutorialManager -[hidden]right- ScorePopupManager
    ScorePopupManager -[hidden]right- RulesConfigManager
    RulesConfigManager -[hidden]right- GestureManager
    GestureManager -[hidden]right- FeedbackManager
}

' ============================================================================
' UTILITIES PACKAGE
' ============================================================================

package "Utilities" <<Utility>> {
    together {
        class SessionManager <<Utility>> {
            + getOrCreateUserId()
            + generateSessionId()
        }
        
        class PathGenerator <<Utility>> {
            + generateDynamicPath(landmarks, exercise)
        }
        
        class DataExporter <<Utility>> {
            + exportJSON(data)
            + exportCSV(data)
        }
    }
    
    ' Force horizontal layout
    SessionManager -[hidden]right- PathGenerator
    PathGenerator -[hidden]right- DataExporter
}

' ============================================================================
' RELATIONSHIPS (Simplified - ไม่มี label เพื่อความสะอาด)
' ============================================================================

' Controller relationships
Script --> KeyboardController
Script --> DisplayController
Script --> HeuristicsEngine
Script --> CalibrationManager
Script --> DrawingManager
Script --> UIManager
Script --> AudioManager
Script --> TutorialManager
Script --> GestureManager

' Display Controller
DisplayController --> GhostManager
DisplayController --> SilhouetteManager
KeyboardController ..> DisplayController

' Core relationships
HeuristicsEngine ..> CalibrationManager
ScoringManager <.. HeuristicsEngine
DrawingManager <.. HeuristicsEngine

' UI relationships
UIManager --> ScorePopupManager
ScoringManager .[norank].> ScorePopupManager
Script --> FeedbackManager
RulesConfigManager --> HeuristicsEngine

' Utilities (เส้นประ = indirect)
Script ..> SessionManager
Script ..> PathGenerator
Script ..> DataExporter

' ============================================================================
' ARCHITECTURE NOTE
' ============================================================================

note as N1
    **TaijiFlow AI Architecture**
    
    MVC-like Pattern (5 Packages):
    - **Controllers**: script.js + Keyboard + Display
    - **Core**: HeuristicsEngine, Calibration, Scoring
    - **Display**: Drawing, Ghost, Silhouette
    - **UI**: UIManager + 6 more
    - **Utility**: Session, Path, Exporter
    
    Total: 18 Classes, 21 Modules
end note

@enduml
