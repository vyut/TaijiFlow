@startuml TaijiFlow_Class_Diagram
' ============================================================================
' TaijiFlow AI - Class Diagram (Detailed)
' ============================================================================
' Focus: Architectural Components, Managers & Public Interfaces
' Note: Internal helpers and private methods are partially omitted for clarity.
' ============================================================================

skinparam defaultFontName "Sarabun"
skinparam packageStyle rectangle
left to right direction
skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 60

skinparam class {
    BackgroundColor White
    BorderColor Black
    ArrowColor Black
}
skinparam package {
    BackgroundColor<<Controller>> #E3F2FD
    BackgroundColor<<Core>> #FFF3E0
    BackgroundColor<<Display>> #E0F7FA
    BackgroundColor<<UI>> #E8F5E9
}

' ============================================================================
' 1. MAIN CONTROLLER
' ============================================================================
package "Controllers" <<Controller>> {
    class "script.js" as Script <<Main>> {
        - state: object
        --
        + init()
        + loop(timestamp)
        + toggleTraining()
        + onPoseResults(results)
    }
}

' ============================================================================
' 2. CORE LOGIC (The Brains)
' ============================================================================
package "Core Managers" <<Core>> {

    class HeuristicsEngine {
        - CONFIG: object
        - calibrationData: object
        - RULES_CONFIG: object
        --
        + analyze(landmarks, timestamp, refPath, exercise): Feedback[]
        + setCalibration(data)
        + updateRuleConfig(level)
        + setDebugMode(enabled)
        - checkPathShape()
        - checkArmRotation()
        - checkElbowSinking()
        - checkWaistInitiation()
        - checkVerticalStability()
        - checkSmoothness()
        - checkContinuity()
        - checkWeightShift()
        - checkCoordination()
    }
    
    class CalibrationManager {
        - isActive: boolean
        - calibrationData: object
        --
        + start()
        + stop()
        + process(landmarks): object
        + saveToStorage()
        + loadFromStorage()
        - calculateMetrics(landmarks)
    }
    
    class ScoringManager {
        - errorCounts: object
        - totalFrames: number
        --
        + start()
        + stop(): object
        + recordFrame(feedbacks)
        + getCurrentScore(): number
        + getSummary(): object
    }
    
    class CameraManager {
        - pose: Pose
        - camera: Camera
        - currentPerformanceMode: string
        --
        + start(onResultsCallback)
        + stop()
        + setPerformanceMode(mode)
        + getTargetResolution()
    }
    
    class PerformanceMonitor {
        - fps: number
        - qualityLevel: string
        --
        + check(currentFps)
        + reset()
    }
}

' ============================================================================
' 3. VISUALIZATION (The Eyes)
' ============================================================================
package "Display Managers" <<Display>> {
    class DrawingManager {
        - ctx: CanvasRenderingContext2D
        --
        + drawSkeleton(landmarks, errorJoints)
        + drawPath(path, color)
        + drawTrail(history)
        + drawFeedbackPanel(feedbacks)
        + drawDebugOverlay(info)
        + setMirror(enabled)
    }

    class DisplayController {
        - options: object
        --
        + init()
        + toggleInstructor()
        + toggleMirror()
        + toggleSkeleton()
        + setVirtualBackground(mode)
    }
    
    class GhostManager {
        + loadReference(exercise)
        + syncWithVideo(timestamp)
        + drawGhostSkeleton(ctx)
    }
    
    class BackgroundManager {
        + setMode(mode)
        + drawBackground(ctx)
    }
    
    class WebGLManager {
        + init(canvas)
        + applyGaussianBlur()
        + renderSegmentation()
    }
}

' ============================================================================
' 4. INTERACTION (The Interface)
' ============================================================================
package "UI Managers" <<UI>> {
    class UIManager {
        - currentLang: string
        - currentTheme: string
        - translations: object
        --
        + init()
        + toggleLanguage()
        + toggleTheme()
        + showNotification(msg)
        + updateText()
        + checkMobileDevice()
    }

    class AudioManager {
        + speak(text)
        + playSound(name)
        + setLanguage(lang)
    }

    class TutorialManager {
        + open()
        + switchTab(index)
    }

    class ScorePopupManager {
        + show(summaryData)
    }

    class RulesConfigManager {
        + init()
        + syncUIWithEngine()
        + setRuleEnabled(rule, enabled)
    }
    
    class GestureManager {
        + detect(landmarks)
    }
    
    class Chatbot {
        + toggleChat()
        + sendMessage(text)
    }
}

' ============================================================================
' RELATIONSHIPS
' ============================================================================

' Main relationships
Script --> CameraManager : controls
Script --> HeuristicsEngine : uses
Script --> CalibrationManager : manages
Script --> ScoringManager : manages
Script --> DrawingManager : renders
Script --> UIManager : events
Script --> PerformanceMonitor : updates

' Core Dependencies
HeuristicsEngine --> CalibrationManager : reads attributes
PerformanceMonitor --> CameraManager : adjusts

' Display Dependencies
DisplayController ..> DrawingManager : configures
DisplayController ..> GhostManager : controls
DisplayController ..> BackgroundManager : controls
BackgroundManager ..> WebGLManager : uses

' UI Dependencies
UIManager ..> AudioManager : triggers
UIManager ..> TutorialManager : controls
UIManager ..> ScorePopupManager : shows
Script --> RulesConfigManager : configures

@enduml
