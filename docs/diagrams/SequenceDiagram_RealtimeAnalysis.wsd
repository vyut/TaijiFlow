@startuml SequenceDiagram_RealtimeAnalysis
' ============================================================================
' TaijiFlow AI - Sequence Diagram: Real-time Pose Analysis
' ============================================================================
' แสดงการวิเคราะห์ท่าแบบ Real-time ในแต่ละ Frame
' อ้างอิง: onResults() callback ใน script.js (lines 1200-1470)
' ============================================================================

skinparam defaultFontName "Sarabun"
skinparam backgroundColor transparent
skinparam sequenceMessageAlign center

' === Participants ===
participant "MediaPipe\nPose" as MediaPipe #E8F5E9
participant " Training " as Training #E3F2FD
participant "Heuristics" as Heuristics #FFF3E0
participant "  Scorer  " as Scorer #FFF3E0
participant "  Drawing " as Drawing #E0F7FA
participant "    UI    " as UI #E8F5E9

' ============================================================================
' MAIN LOOP: onResults Callback
' ============================================================================

loop Camera Loop: ทุก Frame (~30 fps)
    MediaPipe -> Training : onFrame(video)
    activate Training
    
    Training -> Training : throttleFrameCounter++
    
    ' === Throttling Check ===
    opt Process Frame (Dynamic Skipping: Lite/Balanced/Quality)
        Training -> MediaPipe : pose.send(video)
        MediaPipe -> Training : onResults(results)
        
        ' === Environmental Check (Low Light) ===
        opt Environmental Check
            Training -> Training : checkAvgVisibility()
            alt visibility < 0.5 (Low Light)
                Training -> UI : showNotification("แสงน้อย")
                Training -> UI : audioManager.speak()
            end
        end

        ' === Step 1: Analyze Pose (8 Rules) ===
        group #FFF3E0 วิเคราะห์ท่า (9 กฎ)
            Training -> Heuristics : analyze(landmarks)
            activate Heuristics
            
            Heuristics -> Heuristics : 1. checkPathShape()
            note right: เส้นทางเป็นวงโค้ง
            
            Heuristics -> Heuristics : 2. checkWaistInitiation()
            note right: เอวนำการเคลื่อนไหว
            
            Heuristics -> Heuristics : 3. checkWeightShift()
            note right: ถ่ายน้ำหนักสมดุล
            
            Heuristics -> Heuristics : 4. checkVerticalStability()
            note right: ศีรษะนิ่ง ไม่โยก
            
            Heuristics -> Heuristics : 5. checkArmRotation()
            note right: หมุนฝ่ามือถูกทิศ
            
            Heuristics -> Heuristics : 6. checkElbowSinking()
            note right: ศอกจม ไม่ลอย
            
            Heuristics -> Heuristics : 7. checkSmoothness()
            note right: เคลื่อนไหวลื่นไหล
            
            Heuristics -> Heuristics : 8. checkContinuity()
            Heuristics -> Heuristics : 8. checkContinuity()
            note right: ต่อเนื่อง ไม่หยุดนิ่ง

            Heuristics -> Heuristics : 9. checkCoordination()
            note right: บนล่างสัมพันธ์กัน
            
            Heuristics --> Training : { feedback, errorJoints }
            deactivate Heuristics
        end
        
        ' === Step 2: Record Data ===
        group #FFF3E0 บันทึกข้อมูล (Recording)
            Training -> Scorer : recordFrame(feedbacks)
            Training -> Training : recordedSessionData.push()
        end
        
        ' === Step 4: Show Feedback ===
        alt มี feedback ใหม่
            Training -> UI : updateFeedbackOverlay()
            note right: แสดงข้อความ (HTML)
            Training -> UI : audioManager.speakFeedback()
        end
    end
    
    ' === Step 3: Draw Visuals (Every Frame 30 FPS) ===
    group #E0F7FA วาดภาพ (Rendering @ 30 FPS)
        Training -> Drawing : drawSkeleton(..., errorJoints)
        note right: วาดโครง + จุดแดง (Highlights)
        Training -> Drawing : drawPath / drawTrail
    end
    
    deactivate Training
end

@enduml
