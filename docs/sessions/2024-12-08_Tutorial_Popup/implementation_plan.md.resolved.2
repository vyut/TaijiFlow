# Heuristics Engine Refactoring Plan

## üéØ Objectives

1. **Fix Double Transform** - ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ canvas transform ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
2. **Add Timestamps** - ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÉ‡∏ô wristHistory ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö time-based calculations
3. **Create Config** - ‡∏¢‡πâ‡∏≤‡∏¢ thresholds ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô config object
4. *(Optional)* **Debug Overlay** - ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏° D

---

## üìã Proposed Changes

### 1. Fix Double Transform ‚ö†Ô∏è

**Current Issue:**
```javascript
// script.js:607-619 - ‡∏ó‡∏≥ transform 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
canvasCtx.scale(-1, 1);              // Mirror 1
canvasCtx.translate(-canvasElement.width, 0);
canvasCtx.drawImage(...);
canvasCtx.scale(-1, 1);              // Mirror 2 (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Mirror 1)
canvasCtx.translate(-canvasElement.width, 0);

// drawing_manager.js:24-25 - ‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ method
this.ctx.scale(-1, 1);               // Mirror 3!
this.ctx.translate(-this.canvasWidth, 0);
```

**Solution:**
- ‡πÉ‡∏ä‡πâ `ctx.save()` / `ctx.restore()` ‡∏£‡∏≠‡∏ö video drawing
- ‡πÉ‡∏´‡πâ [DrawingManager](file:///Users/yut/TaijiFlow/js/drawing_manager.js#10-150) ‡∏£‡∏±‡∏ö `mirror` flag ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ hardcode
- Landmarks ‡∏à‡∏≤‡∏Å MediaPipe ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å mirror ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ engine ‡∏ï‡∏£‡∏á‡πÜ

---

#### [MODIFY] [script.js](file:///Users/yut/TaijiFlow/js/script.js)

```diff
// onResults() function
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

  // Draw Video (Mirror) - ‡πÉ‡∏ä‡πâ save/restore
+ canvasCtx.save();
  canvasCtx.scale(-1, 1);
  canvasCtx.translate(-canvasElement.width, 0);
  canvasCtx.drawImage(...);
- canvasCtx.scale(-1, 1);
- canvasCtx.translate(-canvasElement.width, 0);
+ canvasCtx.restore();  // ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô identity transform
```

---

#### [MODIFY] [drawing_manager.js](file:///Users/yut/TaijiFlow/js/drawing_manager.js)

‡πÄ‡∏û‡∏¥‡πà‡∏° `mirror` parameter ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢ mirror logic ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:

```diff
class DrawingManager {
  constructor(canvasCtx, canvasElement) {
    this.ctx = canvasCtx;
    this.canvasWidth = canvasElement.width;
    this.canvasHeight = canvasElement.height;
+   this.mirrorDisplay = true; // Default: mirror for user
  }

+ setMirror(enabled) {
+   this.mirrorDisplay = enabled;
+ }

  drawSkeleton(landmarks) {
    this.ctx.save();
-   this.ctx.scale(-1, 1);
-   this.ctx.translate(-this.canvasWidth, 0);
+   if (this.mirrorDisplay) {
+     this.ctx.scale(-1, 1);
+     this.ctx.translate(-this.canvasWidth, 0);
+   }
    // ... draw
    this.ctx.restore();
  }
}
```

---

### 2. Add Timestamps to wristHistory

**Current Issue:**
```javascript
this.wristHistory.push(wrist);  // Only {x, y}
```

**Solution:**
```javascript
this.wristHistory.push({ x: wrist.x, y: wrist.y, t: timestamp });
```

#### [MODIFY] [heuristics_engine.js](file:///Users/yut/TaijiFlow/js/heuristics_engine.js)

- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô `wristHistory` ‡πÄ‡∏Å‡πá‡∏ö `{x, y, t}`
- Update [checkSmoothness()](file:///Users/yut/TaijiFlow/js/heuristics_engine.js#371-396) ‡πÉ‡∏ä‡πâ `dt = (p2.t - p1.t) / 1000`
- Update [checkContinuity()](file:///Users/yut/TaijiFlow/js/heuristics_engine.js#397-413) ‡πÉ‡∏ä‡πâ time-based pause detection

---

### 3. Create Config Object

#### [MODIFY] [heuristics_engine.js](file:///Users/yut/TaijiFlow/js/heuristics_engine.js)

```javascript
// ‡∏¢‡πâ‡∏≤‡∏¢ magic numbers ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô config
this.CONFIG = {
  // Path Accuracy
  PATH_THRESHOLD_DEFAULT: 0.08,        // normalized units
  PATH_THRESHOLD_MIN: 0.02,
  PATH_THRESHOLD_MAX: 0.25,
  
  // Arm Rotation
  ARM_MOTION_THRESHOLD: 0.005,          // min deltaY to check
  
  // Elbow
  ELBOW_TOLERANCE_RATIO: 0.05,          // 5% of torsoHeight
  
  // Waist Initiation
  MIN_HIP_VELOCITY_DEG_SEC: 2.0,        // degrees/second
  SHOULDER_HIP_RATIO: 3.0,              // shoulder must be 3x faster
  
  // Stability
  STABILITY_WINDOW_FRAMES: 30,          // ~1 second at 30fps
  STABILITY_THRESHOLD_RATIO: 0.1,       // 10% of torsoHeight
  
  // Smoothness
  SMOOTHNESS_THRESHOLD_DEFAULT: 0.02,   // normalized units/sec¬≤
  SMOOTHNESS_CALIBRATION_RATIO: 0.05,   // 5% of armLength
  
  // Continuity  
  MOTION_THRESHOLD: 0.001,              // normalized units
  PAUSE_COUNT_THRESHOLD: 15,            // frames (~0.5 sec)
  
  // Weight Shift
  WEIGHT_BUFFER_RATIO: 0.1,             // 10% of stanceWidth
  
  // Feedback
  FEEDBACK_HOLD_TIME_MS: 1500,          // 1.5 seconds
};
```

---

## üî¨ Debug Overlay Analysis

| Aspect | Analysis |
|--------|----------|
| **‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå** | ‚úÖ ‡∏ä‡πà‡∏ß‡∏¢ tune thresholds, ‡∏î‡∏π realtime values, debug ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ |
| **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô** | ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á - ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î text overlay ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤ |
| **‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà** | ‚úÖ **‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥** - ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢ development ‡πÅ‡∏•‡∏∞ user ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á |

**Proposed Debug Info:**
- Wrist velocity (normalized/sec)
- Hand roll angle (degrees)
- Hip center position
- Current thresholds
- FPS

**Toggle:** ‡∏Å‡∏î `D` ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î

---

## ‚úÖ Verification Plan

### Automated Tests
- ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ skeleton/path ‡∏ß‡∏≤‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô)
- ‡∏ó‡∏î‡∏™‡∏≠‡∏ö smoothness/continuity ‡∏î‡πâ‡∏ß‡∏¢ mock wristHistory

### Manual Verification
- ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° D ‡∏î‡∏π debug overlay
- ‡∏ó‡∏î‡∏™‡∏≠‡∏ö feedback ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß

---

## üìÑ Documentation Deliverables

‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á:
1. **Heuristics Engine Manual** - ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏é
2. **Configuration Guide** - ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏±‡∏ö thresholds
3. **Changelog** - ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á

---

> **Request:** ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ review plan ‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
