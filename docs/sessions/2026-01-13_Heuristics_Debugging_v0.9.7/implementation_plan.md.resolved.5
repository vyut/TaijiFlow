# Implementation Plan: Smart Audio Wait & Speech Cleanup

## Goal
1.  Eliminate audio overlaps ("Calibration..." vs "Right Hand...") by implementing a true "Wait for completion" mechanism instead of fixed delays.
2.  Remove the unwanted "ป้ายเตือน" (Warning Label) prefix from low-light warnings.

## 1. Smart Audio Queueing (Audio Manager)

### [js/audio_manager.js](file:///Users/yut/TaijiFlow/js/audio_manager.js)
-   **New Method:** `waitForIdle()`
    -   Returns a `Promise` that resolves when `window.speechSynthesis.speaking` becomes `false`.
    -   Uses a polling mechanism (e.g., `setInterval` every 100ms) to check status.
    -   Includes a safety timeout (e.g., 5 seconds) to prevent infinite hanging if the browser gets stuck.

### [js/script.js](file:///Users/yut/TaijiFlow/js/script.js) -> [showCountdown](file:///Users/yut/TaijiFlow/js/script.js#521-551)
-   **Refactor:**
    -   Remove `setTimeout` wrapping the exercise name speech.
    -   Insert `await audioManager.waitForIdle()` **before** calling `audioManager.speak(exerciseText)`.
    -   This ensures "Calibration Complete" is fully finished before "Right Hand..." starts.
    -   **Note:** [showCountdown](file:///Users/yut/TaijiFlow/js/script.js#521-551) must handle this async flow correctly. Since it already returns a `Promise`, we can use `async/await` inside the existing Promise wrapper or convert it to `async function`.

## 2. Removing "ป้ายเตือน" Prefix

### Investigation
-   Search for code triggering the Low Light warning.
-   Identify if there are duplicate triggers:
    1.  `audioManager.speak("แสงสว่างไม่พอ")`
    2.  `alert("แสงสว่างไม่พอ")` -> Browsers read "Alert..." ("ป้ายเตือน") automatically.
    3.  `uiManager.show...` triggering an ARIA live region update.

### Fix
-   If utilizing `alert()`: Replace with a custom non-blocking toast/notification (using `uiManager`) OR silence the `audioManager.speak` if reasonable.
-   However, pure `audioManager.speak` shouldn't prefix "ป้ายเตือน". The issue is likely a system dialog (`alert`) or notification causing the system reader to chime in.
-   **Action:** Locate the `alert()` call in low-light logic and replace/modify it.

## Verification
1.  **Audio Flow:** Run calibration. Verify "Calibration Complete" finishes fully -> 3-2-1 starts -> "Right Hand..." speaks clearly -> "Start Training".
2.  **Low Light:** Trigger low light. Verify only "แสงสว่างไม่เพียงพอ" is heard, no "ป้ายเตือน".
